language: node_js
# When changing node version also update it on lines 34, 36 and 46.
node_js:
  - "0.12"
sudo: false
cache:
  directories:
    - node_modules
    - core/client/node_modules
    - core/client/bower_components
addons:
  postgresql: "9.3"
env:
  global:
    - GITHUB_OAUTH_KEY=003a44d58f12089d0c0261338298af3813330949
    - GHOST_NODE_VERSION_CHECK=false
    - TEST_SUITE=server
    - DB=sqlite3 NODE_ENV=testing
branches:
  exclude:
    - /^greenkeeper-.+$/
before_install:
  - if [ $DB == "mysql" ]; then mysql -e 'create database ghost_testing'; fi
  - npm install grunt bower grunt-cli -g
  - npm install
  - grunt release
after_success:
  - |
      if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
        if [[ "$DB" = "sqlite3" && "$TRAVIS_NODE_VERSION" = "0.10" ]]; then
          echo "Generate coverage..."
          grunt coverage
          npm install -g codeclimate-test-reporter
          codeclimate-test-reporter < core/test/coverage/unit/lcov.info
        else
          echo "False DB and NODE_VERSION. No coverage generated."
        fi
      else
        echo "This is a PR. No coverage generated."
      fi
deploy:
  - provider: s3
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    local_dir: .dist/release
    skip_cleanup: true
    bucket: enhancv
    on:
      branch: stable
  - provider: codedeploy
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    key: Ghost-release.zip
    bundle_type: zip
    application: "Blog"
    deployment_group: "Blog"
    bucket: enhancv
    on:
      branch: stable
